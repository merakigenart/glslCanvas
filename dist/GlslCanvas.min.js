!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).GlslCanvas=t()}(this,function(){"use strict";var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},i=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),r=function(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)},n="";var a='\n\tThis page requires a browser that supports WebGL.<br/>\n\t<a href="http://get.webgl.org">Click here to upgrade your browser.</a>\n',s='\n\tIt does not appear your computer can support WebGL.<br/>\n\t<a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>\n',o=1,h=2;function l(e,t,i){function r(t,r){var n,a;"function"==typeof i?i(t):(n=r,(a=e.parentNode)&&(a.innerHTML='\n<table style="background-color: #8CE; width: 100%; height: 100%;"><tr>\n<td align="center">\n<div style="display: table-cell; vertical-align: middle;">\n<div style="">'+n+"</div>\n</div>\n</td></tr></table>\n"))}if(!window.WebGLRenderingContext)return r(o,a),null;var n=function(e,t){for(var i=["webgl","experimental-webgl"],r=null,n=0;n<i.length;++n)try{r=e.getContext(i[n],t)}catch(e){if(r)break}return r}(e,t);return n?n.getExtension("OES_standard_derivatives"):r(h,s),n}function u(e,t,i,r){var a=e.gl,s=a.createShader(i);return a.shaderSource(s,t),a.compileShader(s),a.getShaderParameter(s,a.COMPILE_STATUS)?s:(n=a.getShaderInfoLog(s),console.error("*** Error compiling shader "+s+":"+n),e.trigger("error",{shader:s,source:t,type:i,error:n,offset:r||0}),a.deleteShader(s),null)}function f(e,t,i,r){for(var a=e.gl,s=a.createProgram(),o=0;o<t.length;++o)a.attachShader(s,t[o]);if(i)for(var h=0;h<i.length;++h)a.bindAttribLocation(s,r?r[h]:h,i[h]);return a.linkProgram(s),a.getProgramParameter(s,a.LINK_STATUS)?s:(n=a.getProgramInfoLog(s),console.log("Error in program linking:"+n),a.deleteProgram(s),null)}function g(e){return 0==(e&e-1)}function d(e){var t=new Set;return Object.assign(e,{on:function(e,i){var r={};r[e]=i,t.add(r)},off:function(e,i){if(i){var r={};r[e]=i,t.delete(r)}else{var n=!0,a=!1,s=void 0;try{for(var o,h=t[Symbol.iterator]();!(n=(o=h.next()).done);n=!0){var l=o.value,u=!0,f=!1,g=void 0;try{for(var d,c=Object.keys(l)[Symbol.iterator]();!(u=(d=c.next()).done);u=!0){if(d.value===e)return void t.delete(l)}}catch(e){f=!0,g=e}finally{try{!u&&c.return&&c.return()}finally{if(f)throw g}}}}catch(e){a=!0,s=e}finally{try{!n&&h.return&&h.return()}finally{if(a)throw s}}}},listSubscriptions:function(){var e=!0,i=!1,r=void 0;try{for(var n,a=t[Symbol.iterator]();!(e=(n=a.next()).done);e=!0){var s=n.value;console.log(s)}}catch(e){i=!0,r=e}finally{try{!e&&a.return&&a.return()}finally{if(i)throw r}}},subscribe:function(e){t.add(e)},unsubscribe:function(e){t.delete(e)},unsubscribeAll:function(){t.clear()},trigger:function(e){for(var i=arguments.length,n=Array(i>1?i-1:0),a=1;a<i;a++)n[a-1]=arguments[a];var s=!0,o=!1,h=void 0;try{for(var l,u=t[Symbol.iterator]();!(s=(l=u.next()).done);s=!0){var f=l.value;"function"==typeof f[e]&&f[e].apply(f,r(n))}}catch(e){o=!0,h=e}finally{try{!s&&u.return&&u.return()}finally{if(o)throw h}}}})}var c=function(){function e(i,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};t(this,e),d(this),this.gl=i,this.texture=i.createTexture(),this.texture&&(this.valid=!0),this.bind(),this.name=r,this.source=null,this.sourceType=null,this.loading=null,this.setData(1,1,new Uint8Array([0,0,0,255]),{filtering:"linear"}),this.setFiltering(n.filtering),this.load(n)}return i(e,[{key:"destroy",value:function(){this.valid&&(this.gl.deleteTexture(this.texture),this.texture=null,delete this.data,this.data=null,this.valid=!1)}},{key:"bind",value:function(t){this.valid&&("number"==typeof t&&e.activeUnit!==t&&(this.gl.activeTexture(this.gl.TEXTURE0+t),e.activeUnit=t),e.activeTexture!==this.texture&&(this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),e.activeTexture=this.texture))}},{key:"load",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.loading=null,"string"==typeof e.url?void 0!==this.url&&e.url===this.url||this.setUrl(e.url,e):e.element?this.setElement(e.element,e):e.data&&e.width&&e.height&&this.setData(e.width,e.height,e.data,e)}},{key:"setUrl",value:function(e){if(this.valid)throw new Error("loading external urls not allowed")}},{key:"setData",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.width=e,this.height=t,this.source=i,this.sourceType="data",this.update(r),this.setFiltering(r),this.loading=Promise.resolve(this),this.loading}},{key:"setElement",value:function(e,t){var i=this,r=e;if("string"==typeof e&&(e=document.querySelector(e)),e instanceof HTMLCanvasElement||e instanceof HTMLImageElement||e instanceof HTMLVideoElement)this.source=e,this.sourceType="element",e instanceof HTMLVideoElement?(e.addEventListener("canplaythrough",function(){i.intervalID=setInterval(function(){i.update(t)},15)},!0),e.addEventListener("ended",function(){e.currentTime=0,e.play()},!0)):this.update(t),this.setFiltering(t);else{var n="the 'element' parameter (`element: "+JSON.stringify(r)+"`) must be a CSS ";n+="selector string, or a <canvas>, <image> or <video> object",console.log("Texture '"+this.name+"': "+n,t)}return this.loading=Promise.resolve(this),this.loading}},{key:"update",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.valid&&(this.bind(),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!1!==e.UNPACK_FLIP_Y_WEBGL),this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.UNPACK_PREMULTIPLY_ALPHA_WEBGL||!1),"element"===this.sourceType&&(this.source instanceof HTMLCanvasElement||this.source instanceof HTMLVideoElement||this.source instanceof HTMLImageElement&&this.source.complete)?(this.source instanceof HTMLVideoElement?(this.width=this.source.videoWidth,this.height=this.source.videoHeight):(this.width=this.source.width,this.height=this.source.height),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.source)):"data"===this.sourceType&&this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.width,this.height,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.source),this.trigger("loaded",this))}},{key:"setFiltering",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.valid){this.powerOf2=g(this.width)&&g(this.height);var t=this.powerOf2?"mipmap":"linear";this.filtering=e.filtering||t;var i=this.gl;this.bind(),this.powerOf2?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,e.TEXTURE_WRAP_S||e.repeat&&i.REPEAT||i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,e.TEXTURE_WRAP_T||e.repeat&&i.REPEAT||i.CLAMP_TO_EDGE),"mipmap"===this.filtering?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR_MIPMAP_LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.generateMipmap(i.TEXTURE_2D)):"linear"===this.filtering?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR)):"nearest"===this.filtering&&(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST))):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),"mipmap"===this.filtering&&(this.filtering="linear"),"nearest"===this.filtering?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR)))}}}]),e}();c.getMaxTextureSize=function(e){return e.getParameter(e.MAX_TEXTURE_SIZE)},c.activeUnit=-1;var v=function(){function n(e,i,r){t(this,n),d(this),i=i||{},r=r||{},!e.hasAttribute("data-fullscreen")||"1"!=e.getAttribute("data-fullscreen")&&"true"!=e.getAttribute("data-fullscreen")?(this.width=e.clientWidth,this.height=e.clientHeight):(this.width=window.innerWidth,this.height=window.innerHeight,e.width=window.innerWidth,e.height=window.innerHeight),this.canvas=e,this.gl=void 0,this.program=void 0,this.textures={},this.buffers={},this.uniforms={},this.vbo={},this.isValid=!1,this.animationFrameRequest=void 0,this.BUFFER_COUNT=0,this.vertexString=i.vertexString||"\n#ifdef GL_ES\nprecision mediump float;\n#endif\n\nattribute vec2 a_position;\nattribute vec2 a_texcoord;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n    gl_Position = vec4(a_position, 0.0, 1.0);\n    v_texcoord = a_texcoord;\n}\n",this.fragmentString=i.fragmentString||"\n#ifdef GL_ES\nprecision mediump float;\n#endif\n\nvarying vec2 v_texcoord;\n\nvoid main(){\n    gl_FragColor = vec4(0.0);\n}\n";var a=l(e,i,r.onError);if(a){if(this.gl=a,this.timeLoad=this.timePrev=performance.now(),this.timeDelta=0,this.forceRender=!0,this.paused=!1,this.realToCSSPixels=window.devicePixelRatio||1,e.style.backgroundColor=i.backgroundColor||"rgba(1,1,1,0)",e.hasAttribute("data-fragment"))this.fragmentString=e.getAttribute("data-fragment");else if(e.hasAttribute("data-fragment-url")){e.getAttribute("data-fragment-url");throw new Error("xhr Unsupported")}if(e.hasAttribute("data-vertex"))this.vertexString=e.getAttribute("data-vertex");else if(e.hasAttribute("data-vertex-url")){e.getAttribute("data-vertex-url");throw new Error("xhr Unsupported")}if(this.load(),this.program){var s=a.getAttribLocation(this.program,"a_texcoord");this.vbo.texCoords=a.createBuffer(),this.gl.bindBuffer(a.ARRAY_BUFFER,this.vbo.texCoords),this.gl.bufferData(a.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),a.STATIC_DRAW),this.gl.enableVertexAttribArray(s),this.gl.vertexAttribPointer(s,2,a.FLOAT,!1,0,0);var o=a.getAttribLocation(this.program,"a_position");if(this.vbo.vertices=a.createBuffer(),this.gl.bindBuffer(a.ARRAY_BUFFER,this.vbo.vertices),this.gl.bufferData(a.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),a.STATIC_DRAW),this.gl.enableVertexAttribArray(o),this.gl.vertexAttribPointer(o,2,a.FLOAT,!1,0,0),e.hasAttribute("data-textures")){var h=e.getAttribute("data-textures").split(",");for(var u in h)this.setUniform("u_tex"+u,h[u])}var f={x:0,y:0};document.addEventListener("mousemove",function(e){f.x=e.clientX||e.pageX,f.y=e.clientY||e.pageY},!1);var g=this;return this.setMouse({x:0,y:0}),function e(){g.nMouse>1&&g.setMouse(f),g.resize()&&(g.forceRender=!0),g.render(),g.animationFrameRequest=window.requestAnimationFrame(e)}(),this}}}return i(n,[{key:"destroy",value:function(){for(var e in cancelAnimationFrame(this.animationFrameRequest),this.animated=!1,this.isValid=!1,this.textures)e.destroy&&e.destroy();for(var t in this.textures={},this.attribs)this.gl.deleteBuffer(this.attribs[t]);for(var i in this.gl.useProgram(null),this.gl.deleteProgram(this.program),this.buffers){var r=this.buffers[i];this.gl.deleteProgram(r.program)}this.program=null,this.gl=null}},{key:"load",value:function(e,t){if(t&&(this.vertexString=t),e&&(this.fragmentString=e),this.animated=!1,this.nDelta=(this.fragmentString.match(/u_delta/g)||[]).length,this.nTime=(this.fragmentString.match(/u_time/g)||[]).length,this.nDate=(this.fragmentString.match(/u_date/g)||[]).length,this.nMouse=(this.fragmentString.match(/u_mouse/g)||[]).length,this.animated=this.nDate>1||this.nTime>1||this.nMouse>1,this.fragmentString.search(/sampler2D/g))for(var i=this.fragmentString.split("\n"),r=0;r<i.length;r++){var n=i[r].match(/uniform\s*sampler2D\s*([\w]*);\s*\/\/\s*([\w|\:\/\/|\.|\-|\_]*)/i);if(n){var a=n[2].split(".").pop().toLowerCase();n[1]&&n[2]&&("jpg"===a||"jpeg"===a||"png"===a||"ogv"===a||"webm"===a||"mp4"===a)&&this.setUniform(n[1],n[2])}if(i[r].match(/\s*void\s*main\s*/g))break}var s=u(this,this.vertexString,this.gl.VERTEX_SHADER),o=u(this,this.fragmentString,this.gl.FRAGMENT_SHADER);o?this.isValid=!0:(o=u(this,"void main(){\n\tgl_FragColor = vec4(1.0);\n}",this.gl.FRAGMENT_SHADER),this.isValid=!1);var h=f(this,[s,o]);this.gl.useProgram(h),this.gl.deleteShader(s),this.gl.deleteShader(o),this.program=h,this.change=!0,this.BUFFER_COUNT=0;var l=this.getBuffers(this.fragmentString);Object.keys(l).length&&this.loadPrograms(l),this.buffers=l,this.texureIndex=this.BUFFER_COUNT,this.trigger("load",{}),this.forceRender=!0,this.render()}},{key:"test",value:function(e,t,i){var r=this.vertexString,n=this.fragmentString,a=this.paused,s=this.gl.getExtension("EXT_disjoint_timer_query"),o=s.createQueryEXT(),h=this.isValid;(t||i)&&(this.load(t,i),h=this.isValid,this.forceRender=!0,this.render()),this.paused=!0,s.beginQueryEXT(s.TIME_ELAPSED_EXT,o),this.forceRender=!0,this.render(),s.endQueryEXT(s.TIME_ELAPSED_EXT);var l=this;!function u(){l.forceRender=!0,l.render();var f=s.getQueryObjectEXT(o,s.QUERY_RESULT_AVAILABLE_EXT),g=l.gl.getParameter(s.GPU_DISJOINT_EXT);if(f&&!g){var d={wasValid:h,frag:t||l.fragmentString,vert:i||l.vertexString,timeElapsedMs:s.getQueryObjectEXT(o,s.QUERY_RESULT_EXT)/1e6};l.paused=a,(t||i)&&l.load(n,r),e(d)}else window.requestAnimationFrame(u)}()}},{key:"loadTexture",value:function(t,i,r){var n=this;r||(r={}),"string"==typeof i?r.url=i:"object"===(void 0===i?"undefined":e(i))&&i.data&&i.width&&i.height?(r.data=i.data,r.width=i.width,r.height=i.height):"object"===(void 0===i?"undefined":e(i))&&(r.element=i),this.textures[t]?this.textures[t]&&(this.textures[t].load(r),this.textures[t].on("loaded",function(e){n.forceRender=!0})):(this.textures[t]=new c(this.gl,t,r),this.textures[t].on("loaded",function(e){n.forceRender=!0}))}},{key:"refreshUniforms",value:function(){this.uniforms={}}},{key:"setUniform",value:function(e){for(var t={},i=arguments.length,r=Array(i>1?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];t[e]=r,this.setUniforms(t)}},{key:"setUniforms",value:function(t){var i=function t(i){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,a=[];for(var s in i){var o=i[s],h=void 0;if(n&&(s=n+"."+s),"number"==typeof o)a.push({type:"float",method:"1f",name:s,value:o});else if(Array.isArray(o)){if("number"==typeof o[0])1===o.length?a.push({type:"float",method:"1f",name:s,value:o}):o.length>=2&&o.length<=4?a.push({type:"vec"+o.length,method:o.length+"fv",name:s,value:o}):o.length>4&&a.push({type:"float[]",method:"1fv",name:s+"[0]",value:o});else if("string"==typeof o[0])a.push({type:"sampler2D",method:"1i",name:s,value:o});else if(Array.isArray(o[0])&&"number"==typeof o[0][0]){if(o[0].length>=2&&o[0].length<=4)for(h=0;h<o.length;h++)a.push({type:"vec"+o[0].length,method:o[h].length+"fv",name:s+"["+h+"]",value:o[h]})}else if("object"===e(o[0]))for(h=0;h<o.length;h++)a.push.apply(a,r(t(o[h],s+"["+h+"]")))}else"boolean"==typeof o?a.push({type:"bool",method:"1i",name:s,value:o}):"string"==typeof o?a.push({type:"sampler2D",method:"1i",name:s,value:o}):"object"===(void 0===o?"undefined":e(o))&&a.push.apply(a,r(t(o,s)))}return a}(t);for(var n in i)"sampler2D"===i[n].type?this.loadTexture(i[n].name,i[n].value[0]):this.uniform(i[n].method,i[n].type,i[n].name,i[n].value);this.forceRender=!0}},{key:"setMouse",value:function(e){var t=this.canvas.getBoundingClientRect();if(e&&e.x&&e.x>=t.left&&e.x<=t.right&&e.y&&e.y>=t.top&&e.y<=t.bottom){var i=(e.x-t.left)*this.realToCSSPixels,r=this.canvas.height-(e.y-t.top)*this.realToCSSPixels;this.uniform("2f","vec2","u_mouse",i,r)}}},{key:"uniform",value:function(e,t,i){this.uniforms[i]=this.uniforms[i]||{};for(var r=this.uniforms[i],n=arguments.length,a=Array(n>3?n-3:0),s=3;s<n;s++)a[s-3]=arguments[s];var o,h;if((o=r.value,h=a,!(!o||!h)&&o.toString()!==h.toString())||this.change||!r.location||!r.value)for(var l in r.name=i,r.type=t,r.value=a,r.method="uniform"+e,this.gl.useProgram(this.program),r.location=this.gl.getUniformLocation(this.program,i),this.gl[r.method].apply(this.gl,[r.location].concat(r.value)),this.buffers){var u=this.buffers[l];this.gl.useProgram(u.program);var f=this.gl.getUniformLocation(u.program,i);this.gl[r.method].apply(this.gl,[f].concat(r.value))}}},{key:"uniformTexture",value:function(e,t,i){if(void 0===this.textures[e])this.loadTexture(e,t,i);else{for(var r in this.uniform("1i","sampler2D",e,this.texureIndex),this.buffers){var n=this.buffers[r];this.gl.useProgram(n.program),this.gl.activeTexture(this.gl.TEXTURE0+this.texureIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,this.textures[e].texture)}this.gl.useProgram(this.program),this.gl.activeTexture(this.gl.TEXTURE0+this.texureIndex),this.gl.bindTexture(this.gl.TEXTURE_2D,this.textures[e].texture),this.uniform("2f","vec2",e+"Resolution",this.textures[e].width,this.textures[e].height)}}},{key:"resize",value:function(){if(this.width!==this.canvas.clientWidth||this.height!==this.canvas.clientHeight){this.realToCSSPixels=window.devicePixelRatio||1;var e=Math.floor(this.gl.canvas.clientWidth*this.realToCSSPixels),t=Math.floor(this.gl.canvas.clientHeight*this.realToCSSPixels);return this.gl.canvas.width===e&&this.gl.canvas.height===t||(this.gl.canvas.width=e,this.gl.canvas.height=t,this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height)),this.width=this.canvas.clientWidth,this.height=this.canvas.clientHeight,this.resizeSwappableBuffers(),!0}return!1}},{key:"render",value:function(){var e;if(this.visible=(e=this.canvas).getBoundingClientRect().top+e.height>0&&e.getBoundingClientRect().top<(window.innerHeight||document.documentElement.clientHeight),this.forceRender||this.change||this.animated&&this.visible&&!this.paused){var t=new Date,i=performance.now();for(var r in this.timeDelta=(i-this.timePrev)/1e3,this.timePrev=i,this.nDelta>1&&this.uniform("1f","float","u_delta",this.timeDelta),this.nTime>1&&this.uniform("1f","float","u_time",(i-this.timeLoad)/1e3),this.nDate&&this.uniform("4f","float","u_date",t.getFullYear(),t.getMonth(),t.getDate(),3600*t.getHours()+60*t.getMinutes()+t.getSeconds()+.001*t.getMilliseconds()),this.uniform("2f","vec2","u_resolution",this.canvas.width,this.canvas.height),this.buffers){var n=this.buffers[r];this.uniform("1i","sampler2D",n.name,n.bundle.input.index)}for(var a in this.texureIndex=this.BUFFER_COUNT,this.textures)this.uniformTexture(a),this.texureIndex++;this.renderPrograms(),this.trigger("render",{}),this.change=!1,this.forceRender=!1}}},{key:"pause",value:function(){this.paused=!0}},{key:"play",value:function(){this.paused=!1}},{key:"renderPrograms",value:function(){var e=this.gl,t=e.canvas.width,i=e.canvas.height;for(var r in e.viewport(0,0,t,i),this.buffers){var n=this.buffers[r];n.bundle.render(t,i,n.program,n.name),e.bindFramebuffer(e.FRAMEBUFFER,null)}e.useProgram(this.program),e.drawArrays(e.TRIANGLES,0,6)}},{key:"getBuffers",value:function(e){var t={};return e&&e.replace(/(?:^\s*)((?:#if|#elif)(?:\s*)(defined\s*\(\s*BUFFER_)(\d+)(?:\s*\))|(?:#ifdef)(?:\s*BUFFER_)(\d+)(?:\s*))/gm,function(){var i=arguments[3]||arguments[4];t["u_buffer"+i]={fragment:"#define BUFFER_"+i+"\n"+e}}),t}},{key:"loadPrograms",value:function(e){var t=this.gl,i=u(this,this.vertexString,t.VERTEX_SHADER);for(var r in e){var n=e[r],a=u(this,n.fragment,t.FRAGMENT_SHADER,1);a?this.isValid=!0:(a=u(this,"void main(){\n\tgl_FragColor = vec4(1.0);\n}",t.FRAGMENT_SHADER),this.isValid=!1);var s=f(this,[i,a]);n.name=r,n.program=s,n.bundle=this.createSwappableBuffer(this.canvas.width,this.canvas.height,s),t.deleteShader(a)}t.deleteShader(i)}},{key:"createSwappableBuffer",value:function(e,t,i){var r=this.createBuffer(e,t,i),n=this.createBuffer(e,t,i),a=this.gl;return{input:r,output:n,swap:function(){var e=r;r=n,n=e,this.input=r,this.output=n},render:function(e,t,i,r){a.useProgram(i),a.viewport(0,0,e,t),a.bindFramebuffer(a.FRAMEBUFFER,this.input.buffer),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.output.texture,0),a.drawArrays(a.TRIANGLES,0,6),this.swap()},resize:function(e,t,i,r){a.useProgram(i),a.viewport(0,0,e,t),this.input.resize(e,t),this.output.resize(e,t)}}}},{key:"createBuffer",value:function(e,t,i){var r=this.gl,n=this.BUFFER_COUNT;this.BUFFER_COUNT+=2,r.getExtension("OES_texture_float");var a=r.createTexture();r.activeTexture(r.TEXTURE0+n),r.bindTexture(r.TEXTURE_2D,a),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,e,t,0,r.RGBA,r.FLOAT,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE);var s=r.createFramebuffer();return{index:n,texture:a,buffer:s,W:e,H:t,resize:function(e,t){r.bindFramebuffer(r.FRAMEBUFFER,s);var i=Math.min(e,this.W),o=Math.min(t,this.H),h=new Float32Array(i*o*4);r.readPixels(0,0,i,o,r.RGBA,r.FLOAT,h),r.bindFramebuffer(r.FRAMEBUFFER,null);var l=n+1,u=r.createTexture();r.activeTexture(r.TEXTURE0+l),r.bindTexture(r.TEXTURE_2D,u),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,e,t,0,r.RGBA,r.FLOAT,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texSubImage2D(r.TEXTURE_2D,0,0,0,i,o,r.RGBA,r.FLOAT,h);var f=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,null),r.deleteTexture(a),r.activeTexture(r.TEXTURE0+n),r.bindTexture(r.TEXTURE_2D,u),n=this.index=n,a=this.texture=u,s=this.buffer=f,this.W=e,this.H=t}}}},{key:"resizeSwappableBuffers",value:function(){var e=this.gl,t=e.canvas.width,i=e.canvas.height;for(var r in e.viewport(0,0,t,i),this.buffers){var n=this.buffers[r];n.bundle.resize(t,i,n.program,n.name)}e.useProgram(this.program)}},{key:"version",value:function(){return"0.1.8"}}]),n}();return window.addEventListener("load",function(){!function(){var e=document.getElementsByClassName("glslCanvas");if(e.length>0){window.glslCanvases=[];for(var t=0;t<e.length;t++){var i=new v(e[t]);i.isValid&&window.glslCanvases.push(i)}}}()}),v});
//# sourceMappingURL=GlslCanvas.min.js.map
